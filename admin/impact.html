<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impact Metrics - Sun & Soil Foundation CMS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <img src="../assets/SUN AND SOIL LOGO.png" alt="Sun & Soil Foundation" class="sidebar-logo">
                <div class="sidebar-title">Content Management</div>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li><a href="dashboard.html"><i data-lucide="layout-dashboard" class="icon"></i> Dashboard</a></li>
                    <li><a href="pages.html"><i data-lucide="file-text" class="icon"></i> Pages</a></li>
                    <li><a href="media.html"><i data-lucide="image" class="icon"></i> Media Library</a></li>
                </ul>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Content Types</div>
                    <ul class="sidebar-nav">
                        <li><a href="team.html"><i data-lucide="users" class="icon"></i> Team Members</a></li>
                        <li><a href="projects.html"><i data-lucide="briefcase" class="icon"></i> Projects</a></li>
                        <li><a href="programs.html"><i data-lucide="layers" class="icon"></i> Programs</a></li>
                        <li><a href="impact.html" class="active"><i data-lucide="trending-up" class="icon"></i> Impact Metrics</a></li>
                        <li><a href="contact-info.html"><i data-lucide="phone" class="icon"></i> Contact Info</a></li>
                    </ul>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-section-title">Settings</div>
                    <ul class="sidebar-nav">
                        <li><a href="users.html"><i data-lucide="user-cog" class="icon"></i> Users & Roles</a></li>
                        <li><a href="settings.html"><i data-lucide="settings" class="icon"></i> Site Settings</a></li>
                        <li><a href="history.html"><i data-lucide="clock" class="icon"></i> Version History</a></li>
                    </ul>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-role" id="userRole">Administrator</div>
                    </div>
                </div>
                <button onclick="handleLogout()" class="btn btn-secondary btn-block btn-sm">
                    <i data-lucide="log-out" class="icon"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-content">
                    <h1 class="header-title">Impact Metrics</h1>
                    <div class="header-actions">
                        <button onclick="openAddModal()" class="btn btn-primary btn-sm">
                            <i data-lucide="plus-circle" class="icon"></i>
                            Add Metric
                        </button>
                    </div>
                </div>
            </header>

            <div class="admin-content">
                <!-- Info Card -->
                <div class="card" style="background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%); color: white; margin-bottom: 2rem;">
                    <div style="display: flex; align-items: start; gap: 1rem;">
                        <i data-lucide="info" style="width: 24px; height: 24px; flex-shrink: 0;"></i>
                        <div>
                            <h3 style="margin-bottom: 0.5rem;">About Impact Metrics</h3>
                            <p style="opacity: 0.9; line-height: 1.6;">
                                Impact metrics are the statistics displayed on your homepage that showcase your organization's achievements. 
                                Keep these numbers current and accurate to demonstrate your ongoing impact.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Metrics Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">All Metrics</h2>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Value</th>
                                    <th>Label</th>
                                    <th>Description</th>
                                    <th>Last Updated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="metricsTable">
                                <!-- Metrics will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="emptyState" style="text-align: center; padding: 3rem; color: var(--admin-text-muted); display: none;">
                        <i data-lucide="trending-up" style="width: 64px; height: 64px; margin-bottom: 1rem;"></i>
                        <h3>No Metrics Yet</h3>
                        <p>Add your first impact metric to showcase your achievements.</p>
                        <button onclick="openAddModal()" class="btn btn-primary" style="margin-top: 1rem;">
                            <i data-lucide="plus-circle" class="icon"></i>
                            Add Metric
                        </button>
                    </div>
                </div>

                <!-- Preview Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Homepage Preview</h2>
                    </div>
                    <div class="stats-grid" id="previewGrid">
                        <!-- Preview will be shown here -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="metricModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Impact Metric</h2>
                <button onclick="closeModal()" class="modal-close">
                    <i data-lucide="x" class="icon"></i>
                </button>
            </div>
            <form id="metricForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="metricValue">Value *</label>
                        <input type="text" id="metricValue" name="value" required 
                               placeholder="e.g., 10, 85, 100%, 50K">
                        <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-top: 0.25rem;">
                            The number or statistic (can include %, K, M, etc.)
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="metricLabel">Label *</label>
                        <input type="text" id="metricLabel" name="label" required 
                               placeholder="e.g., Farmers Directly Supported">
                        <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-top: 0.25rem;">
                            Short description of what this metric represents
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="metricDescription">Description</label>
                        <textarea id="metricDescription" name="description" rows="3" 
                                  placeholder="Optional additional context or details"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="metricIcon">Icon</label>
                        <select id="metricIcon" name="icon">
                            <option value="users">Users</option>
                            <option value="trending-up">Trending Up</option>
                            <option value="target">Target</option>
                            <option value="award">Award</option>
                            <option value="heart">Heart</option>
                            <option value="sun">Sun</option>
                            <option value="leaf">Leaf</option>
                            <option value="droplet">Droplet</option>
                            <option value="zap">Zap</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="metricOrder">Display Order</label>
                        <input type="number" id="metricOrder" name="order" min="1" value="1"
                               placeholder="1">
                        <p style="font-size: 0.85rem; color: var(--admin-text-muted); margin-top: 0.25rem;">
                            Lower numbers appear first
                        </p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-lucide="save" class="icon"></i>
                        Save Metric
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/cms-core.js"></script>
    <script>
        auth.requireAuth();
        const cms = new CMSCore();
        let currentEditId = null;

        // Update user info
        const user = auth.getCurrentUser();
        if (user) {
            document.getElementById('userName').textContent = user.name;
            document.getElementById('userRole').textContent = user.role.charAt(0).toUpperCase() + user.role.slice(1);
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
        }

        // Load metrics
        function loadMetrics() {
            const metrics = cms.getAllMetrics().sort((a, b) => (a.order || 999) - (b.order || 999));
            const table = document.getElementById('metricsTable');
            const emptyState = document.getElementById('emptyState');
            const preview = document.getElementById('previewGrid');

            if (metrics.length === 0) {
                table.innerHTML = '';
                emptyState.style.display = 'block';
                preview.innerHTML = '<p style="text-align: center; padding: 2rem; color: var(--admin-text-muted);">No metrics to preview</p>';
            } else {
                emptyState.style.display = 'none';

                table.innerHTML = metrics.map(metric => `
                    <tr>
                        <td><strong style="font-size: 1.25rem; color: var(--primary);">${metric.value}</strong></td>
                        <td>${metric.label}</td>
                        <td>${metric.description || '<span style="color: var(--admin-text-muted);">â€”</span>'}</td>
                        <td>${cms.formatDate(metric.updatedAt)}</td>
                        <td>
                            <div class="table-actions">
                                <button onclick="editMetric('${metric.id}')" class="icon-btn" title="Edit">
                                    <i data-lucide="edit-2" class="icon"></i>
                                </button>
                                <button onclick="deleteMetric('${metric.id}')" class="icon-btn" title="Delete">
                                    <i data-lucide="trash-2" class="icon"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Preview
                preview.innerHTML = metrics.map(metric => `
                    <div class="stat-card">
                        <div class="stat-value">${metric.value}</div>
                        <div class="stat-label">${metric.label}</div>
                    </div>
                `).join('');
            }

            lucide.createIcons();
        }

        // Open add modal
        function openAddModal() {
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add Impact Metric';
            document.getElementById('metricForm').reset();
            document.getElementById('metricModal').style.display = 'flex';
            lucide.createIcons();
        }

        // Edit metric
        function editMetric(id) {
            const metric = cms.read('impact', id);
            if (!metric) return;

            currentEditId = id;

            document.getElementById('modalTitle').textContent = 'Edit Impact Metric';
            document.getElementById('metricValue').value = metric.value || '';
            document.getElementById('metricLabel').value = metric.label || '';
            document.getElementById('metricDescription').value = metric.description || '';
            document.getElementById('metricIcon').value = metric.icon || 'trending-up';
            document.getElementById('metricOrder').value = metric.order || 1;

            document.getElementById('metricModal').style.display = 'flex';
            lucide.createIcons();
        }

        // Delete metric
        function deleteMetric(id) {
            const metric = cms.read('impact', id);
            if (!metric) return;

            if (confirm(`Are you sure you want to delete the metric "${metric.label}"?`)) {
                cms.deleteMetric(id);
                loadMetrics();
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('metricModal').style.display = 'none';
        }

        // Form submission
        document.getElementById('metricForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = {
                value: document.getElementById('metricValue').value,
                label: document.getElementById('metricLabel').value,
                description: document.getElementById('metricDescription').value,
                icon: document.getElementById('metricIcon').value,
                order: parseInt(document.getElementById('metricOrder').value) || 1
            };

            if (currentEditId) {
                cms.updateMetric(currentEditId, formData);
            } else {
                cms.createMetric(formData);
            }

            closeModal();
            loadMetrics();
        });

        // Initial load
        loadMetrics();
        lucide.createIcons();
    </script>
</body>
</html>
